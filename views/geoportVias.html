<!DOCTYPE html>
<html>
<head>
    <title>sidebar-v2 example</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin=""/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="/css/leaflet-sidebar.css" />

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            text-align: justify;
            color: #AAA;
        }
    </style>
</head>
<body>
    <div id="sidebar" class="leaflet-sidebar collapsed">
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars active"></i></a></li>
                <li onclick="crearGrafico()"><a href="#autopan" role="tab"><i class="fa fa-arrows"></i></a></li>
            </ul>
        </div>

        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane" id="home">
                <h1 class="leaflet-sidebar-header">
                    Información Detallada
                    <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                </h1>
                <div id="info-content">
                    <p>Haz clic en un polígono para ver los detalles aquí.</p>
                    
                </div>
            </div>


            <div class="leaflet-sidebar-pane" id="autopan">
                <h1 class="leaflet-sidebar-header">
                    Información Detallada
                    <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                </h1>
                <div id="info-content">
                    <p>positivo.</p>
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
    <script src="/script/leaflet-sidebar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>


    <script>
        // Configuración inicial del mapa
        var map = L.map('map').setView([-17.403868804926827, -66.03924367573562], 13);

        /*L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 22,
            attribution: 'Map data &copy; OpenStreetMap contributors'
        }).addTo(map);*/
        L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20, // Nivel máximo de zoom
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], // Subdominios utilizados por Google para distribuir la carga
            attribution: 'Map data ©2023 Google' // Atribución de los datos del mapa
          }).addTo(map);
          

        // Crear el sidebar y agregarlo al mapa
        var sidebar = L.control.sidebar({ container: 'sidebar' }).addTo(map).open('home');

        // Cargar los datos GeoJSON
        var grilla2024 = 'http://10.0.38.17:8080/geoserver/Vias_Catastro/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=Vias_Catastro%3Avias_poligonos&maxFeatures=20000&outputFormat=application%2Fjson&srsName=EPSG:4326';
        
        fetch(grilla2024)
        .then(response => response.json())
        .then(data => {
            // Agregar los datos GeoJSON al mapa y agregar el evento click
            L.geoJSON(data, {
                onEachFeature: function (feature, layer) {
                    // Asignar un evento de clic a cada polígono
                    layer.on('click', function (e) {
                        // Aquí actualizamos el contenido del sidebar con información del polígono
                        var content = `<h2>Detalles del via</h2>
                                       <p><strong>ID:</strong> ${feature.id}</p>
                                       <p><strong>Propiedades:</strong> ${JSON.stringify(feature.properties)}</p>`;
                        
                        // Cambiar el contenido del panel del sidebar
                        document.getElementById('info-content').innerHTML = content;

                        // Abrir el sidebar
                        sidebar.open('home');
                    });
                }
            }).addTo(map);
        })
        .catch(error => {
            console.error('Error al cargar el archivo GeoJSON:', error);
        });


        async function obtenerPorcentajeMaterial() {
            try {
                const response = await fetch('http://localhost:5000/porcentaje-material');
                if (!response.ok) {
                    throw new Error('Error en la respuesta de la API');
                }
                const data = await response.json();
                return data; // Devolver todo el conjunto de datos
            } catch (error) {
                console.error('Error al obtener el porcentaje de material:', error);
                return null; // O manejar el error según sea necesario
            }
        }
        
        // Crear el gráfico usando Chart.js
        async function crearGrafico() {
            const datos = await obtenerPorcentajeMaterial();
        
            if (!datos) {
                console.error('No se pudieron obtener los datos de los materiales');
                return;
            }
        
            // Extraer etiquetas (materiales) y datos (porcentajes) del resultado de la API
            const etiquetas = datos.map(item => `Material ${item.material}`);
            const porcentajes = datos.map(item => item.porcentaje);
        
            // Crear el gráfico usando Chart.js
            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie', // O 'bar', 'doughnut', etc.
                data: {
                    labels: etiquetas, // Etiquetas de los materiales
                    datasets: [{
                        data: porcentajes, // Datos de los porcentajes
                        backgroundColor: [
                            '#36A2EB', // Color para cada material
                            '#FF6384',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40',
                            '#C9CBCF' // Puedes añadir más colores según los materiales
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
